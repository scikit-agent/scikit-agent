name: Deploy Documentation

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - documentation-*
  pull_request:
    types: [opened, synchronize, reopened, closed]

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: write
  pages: write
  id-token: write
  pull-requests: write
  actions: read

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
concurrency:
  group: "pages-${{ github.event.pull_request.number || github.ref }}"
  cancel-in-progress: false

env:
  FORCE_COLOR: 3

jobs:
  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest
    if: github.event.action != 'closed'
    outputs:
      deployment-path: ${{ steps.path.outputs.path }}
      is-pr: ${{ steps.path.outputs.is-pr }}
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Determine deployment path
        id: path
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "path=pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "is-pr=true" >> $GITHUB_OUTPUT
          else
            echo "path=." >> $GITHUB_OUTPUT
            echo "is-pr=false" >> $GITHUB_OUTPUT
          fi

      - name: Setup Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.12"

      - name: Install graphviz
        run: sudo apt-get update && sudo apt-get install graphviz

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ".[docs]"

      - name: Build documentation
        run: |
          cd docs
          python -m sphinx -b html -W --keep-going . _build
          # Add .nojekyll to prevent GitHub Pages from processing files with underscores
          touch _build/.nojekyll

      - name: Setup Pages
        if: steps.path.outputs.is-pr == 'false'
        uses: actions/configure-pages@v5

      - name: Upload artifact for main branch
        if: steps.path.outputs.is-pr == 'false'
        uses: actions/upload-pages-artifact@v4
        with:
          path: docs/_build

      - name: Upload artifact for PR
        if: steps.path.outputs.is-pr == 'true'
        uses: actions/upload-artifact@v6
        with:
          name: docs-pr-${{ github.event.pull_request.number }}
          path: docs/_build
          retention-days: 30

  deploy-main:
    name: Deploy to GitHub Pages (Main)
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build-docs
    if: needs.build-docs.outputs.is-pr == 'false'
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  deploy-pr:
    name: Deploy PR Preview
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    needs: build-docs
    if:
      ${{ github.event_name == 'pull_request' &&
      !github.event.pull_request.head.repo.fork }}
    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v6
        with:
          ref: gh-pages
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Download artifact
        uses: actions/download-artifact@v7
        with:
          name: docs-pr-${{ github.event.pull_request.number }}
          path: ./pr-${{ github.event.pull_request.number }}

      - name: Commit PR documentation
        run: |
          git add pr-${{ github.event.pull_request.number }}
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Deploy PR #${{ github.event.pull_request.number }} documentation"
            echo "Pushing changes to gh-pages branch..."
            git push origin gh-pages
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on PR
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const repoOwner = context.repo.owner;
            const repoName = context.repo.repo;
            const previewUrl = `https://${repoOwner}.github.io/${repoName}/pr-${prNumber}/`;

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: repoOwner,
              repo: repoName,
              issue_number: prNumber,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ðŸ“– Documentation Preview')
            );

            const commentBody = `## ðŸ“– Documentation Preview

            The documentation for this PR has been deployed and is available at:

            ðŸ”— **[Preview Documentation](${previewUrl})**

            This preview will be updated automatically when you push new commits to this PR.

            > Generated by GitHub Actions â€¢ [View workflow run](https://github.com/${repoOwner}/${repoName}/actions/runs/${{ github.run_id }})`;

            if (botComment) {
              // Update existing comment
              await github.rest.issues.updateComment({
                owner: repoOwner,
                repo: repoName,
                comment_id: botComment.id,
                body: commentBody
              });
            } else {
              // Create new comment
              await github.rest.issues.createComment({
                owner: repoOwner,
                repo: repoName,
                issue_number: prNumber,
                body: commentBody
              });
            }

  cleanup-pr:
    name: Cleanup PR Documentation
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    if: github.event.action == 'closed'
    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v6
        with:
          ref: gh-pages
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Remove PR documentation
        run: |
          if [ -d "pr-${{ github.event.pull_request.number }}" ]; then
            git rm -r pr-${{ github.event.pull_request.number }}
            git commit -m "Remove PR #${{ github.event.pull_request.number }} documentation"
            echo "Pushing changes to gh-pages branch..."
            git push origin gh-pages
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update PR comment
        uses: actions/github-script@v8
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const repoOwner = context.repo.owner;
            const repoName = context.repo.repo;

            // Find existing comment
            const comments = await github.rest.issues.listComments({
              owner: repoOwner,
              repo: repoName,
              issue_number: prNumber,
            });

            const botComment = comments.data.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('ðŸ“– Documentation Preview')
            );

            if (botComment) {
              const commentBody = `## ðŸ“– Documentation Preview

              ~~The documentation for this PR has been deployed and is available at:~~

              ðŸ”— ~~**Preview Documentation**~~ (Removed after PR closure)

              > Generated by GitHub Actions â€¢ [View workflow run](https://github.com/${repoOwner}/${repoName}/actions/runs/${{ github.run_id }})`;

              await github.rest.issues.updateComment({
                owner: repoOwner,
                repo: repoName,
                comment_id: botComment.id,
                body: commentBody
              });
            }
